---
phase: 03-ai-orchestration-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/prompts.py
  - src/models.py
  - tests/test_prompts.py
  - tests/test_models.py
autonomous: true
gap_closure: true
requirements:
  - ORCH-03
must_haves:
  truths:
    - "Incident list entries display the Sentinel incident number (#N) alongside title and severity"
    - "Timestamps produced by format_relative_time() for the yesterday branch are labeled as UTC"
    - "System prompt instructs the LLM to surface incident numbers and label timestamps as UTC"
  artifacts:
    - path: "src/prompts.py"
      provides: "Updated SYSTEM_PROMPT with incident number and UTC labeling rules"
      contains: "incident number"
    - path: "src/models.py"
      provides: "format_relative_time() yesterday branch appends UTC label"
      contains: "UTC"
  key_links:
    - from: "src/models.py format_relative_time()"
      to: "yesterday branch return value"
      via: "string append"
      pattern: "yesterday at.*UTC"
    - from: "src/prompts.py SYSTEM_PROMPT"
      to: "Response Style section"
      via: "instruction text"
      pattern: "incident number"
---

<objective>
Close two UAT gaps from phase 3 UAT testing: (1) Sentinel incident numbers are absent from list
view because the system prompt gives no instruction to surface the number field, and (2) UTC
timestamps in the "yesterday" relative-time branch carry no timezone label, confusing users.

Purpose: Ensure factual accuracy and readability in the chatbot's primary output — incident lists
and timestamps are the two most user-visible data points.
Output: Updated src/prompts.py and src/models.py with matching test assertions.
</objective>

<execution_context>
@C:/Users/AlexSandstrom/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/AlexSandstrom/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/prompts.py
@src/models.py
@tests/test_prompts.py
@tests/test_models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix incident number display in system prompt</name>
  <files>src/prompts.py</files>
  <action>
In SYSTEM_PROMPT, update the "Response Style" section. The existing rule:

  "Number results in lists using [1], [2], [3] format so users can reference specific items
  (e.g., 'tell me more about [2]')."

Replace with a rule that requires displaying the Sentinel incident number AND uses positional
indexing together, for example:

  "When listing incidents, always include the Sentinel incident number in each entry
  (e.g., '#42 [1] – High – Suspicious Login Activity'). Users can reference items by either
  the incident number ('#42') or the positional index ('[1]')."

Keep the rest of the Response Style section intact. Do not alter any other sections of
SYSTEM_PROMPT. Make no changes to TOKEN_WARNING, MAX_ROUNDS_MESSAGE, CLEAR_SUMMARY_TEMPLATE,
or DISCLAIMER.
  </action>
  <verify>pytest tests/test_prompts.py -v</verify>
  <done>SYSTEM_PROMPT contains an explicit instruction about displaying Sentinel incident numbers
in list entries. All existing test_prompts.py tests still pass (the numbered reference test
checks for "[1]" which remains in the updated text).</done>
</task>

<task type="auto">
  <name>Task 2: Append UTC label to yesterday branch and add test coverage</name>
  <files>src/models.py, tests/test_models.py</files>
  <action>
In src/models.py, locate the format_relative_time() function's yesterday branch (seconds
between 86400 and 172799):

  Current: return f"yesterday at {dt.strftime('%I:%M %p').lstrip('0')}"
  Updated: return f"yesterday at {dt.strftime('%I:%M %p').lstrip('0')} UTC"

No other branches need changes — "N hours ago", "N minutes ago", "N days ago", and
"Jan DD, YYYY" are sufficiently self-explanatory or do not surface a bare clock time.

In tests/test_models.py, update the existing test_yesterday test to assert the UTC label:

  Current assertion: assert "AM" in result or "PM" in result
  Add:               assert "UTC" in result

The test_yesterday method currently only checks startswith("yesterday at ") and AM/PM presence.
Add the UTC assertion as a third assert line — do not remove the existing assertions.
  </action>
  <verify>pytest tests/test_models.py::TestFormatRelativeTime -v</verify>
  <done>format_relative_time() returns "yesterday at 3:14 PM UTC" style strings for timestamps
24-48 hours old. test_yesterday passes with the UTC assertion present. All 145+ existing tests
still pass (pytest with no filter).</done>
</task>

<task type="auto">
  <name>Task 3: Add UTC labeling rule to system prompt and verify full suite</name>
  <files>src/prompts.py, tests/test_prompts.py</files>
  <action>
In src/prompts.py SYSTEM_PROMPT, add a UTC timezone rule to the "Response Style" section.
Append after the incident number instruction (or as a separate bullet):

  "All timestamps are in UTC. When presenting times, include a UTC label so analysts
  know the timezone (e.g., 'yesterday at 3:14 PM UTC', '2 hours ago (UTC)')."

In tests/test_prompts.py, add a new test method to TestSystemPrompt:

  def test_contains_utc_instruction(self):
      """Must instruct the LLM to label timestamps as UTC."""
      assert "UTC" in SYSTEM_PROMPT

Run the full test suite to confirm no regressions.
  </action>
  <verify>pytest -v 2>&1 | tail -20</verify>
  <done>SYSTEM_PROMPT contains both the incident number instruction (Task 1) and the UTC labeling
rule (Task 3). test_contains_utc_instruction passes. Full pytest run shows all tests green with
no failures.</done>
</task>

</tasks>

<verification>
Run the full test suite:
  pytest -v

Expected: all tests pass (145+ tests, 0 failures).

Manual spot-check of the prompts change:
  python -c "from src.prompts import SYSTEM_PROMPT; print([l for l in SYSTEM_PROMPT.splitlines() if 'incident number' in l.lower() or 'UTC' in l])"

Expected output: two non-empty lines — one referencing incident numbers, one referencing UTC.

Manual spot-check of the models change:
  python -c "from datetime import UTC, datetime, timedelta; from src.models import format_relative_time; dt = datetime.now(UTC) - timedelta(hours=30); print(format_relative_time(dt))"

Expected output: "yesterday at H:MM AM/PM UTC"
</verification>

<success_criteria>
- format_relative_time() yesterday branch returns strings ending in " UTC"
- SYSTEM_PROMPT instructs the LLM to show Sentinel incident numbers (#N) in list entries
- SYSTEM_PROMPT instructs the LLM to label all timestamps as UTC
- All existing tests pass; two new assertions added (UTC in yesterday test, UTC instruction test)
- No changes to any other function signatures, model fields, or module exports
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-orchestration-integration/03-03-SUMMARY.md`
using the standard summary template.
</output>
